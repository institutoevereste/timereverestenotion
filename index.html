<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Evereste | Versão Melhorada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <style>
        /* Estilo para a barra de scroll */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }

        /* Animações */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-bubble {
            max-width: 80%;
        }

        .tag-color {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        /* Animação de pulsar */
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        .pulse-red-animate {
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-green {
             0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }
        .pulse-green-animate {
            animation: pulse-green 2s infinite;
        }
        
        #open-chat-btn {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            cursor: move;
            touch-action: none; /* Previne o scroll em dispositivos de toque */
        }
        
        #chat-modal {
            position: fixed;
            z-index: 100;
        }

        /* Estilos para o Date Range Picker */
        .daterangepicker { background-color: #374151 !important; border-color: #4b5563 !important; }
        .daterangepicker .calendar-table { background-color: #374151 !important; }
        .daterangepicker th, .daterangepicker td { color: #d1d5db !important; }
        .daterangepicker .off, .daterangepicker .off.in-range, .daterangepicker .off.start-date, .daterangepicker .off.end-date { background-color: #1f2937 !important; color: #6b7280 !important; }
        .daterangepicker .drp-buttons .btn { background-color: #4f46e5 !important; border-color: #4f46e5 !important; color: white !important; }
        .daterangepicker .drp-buttons .btn-default { background-color: #4b5563 !important; border-color: #4b5563 !important; }

        /* Estilos do Tutorial */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9998;
        }
        .tutorial-highlight {
            position: absolute;
            border: 3px solid #6366f1;
            border-radius: 8px;
            box-shadow: 0 0 15px #6366f1, 0 0 0 9999px rgba(0, 0, 0, 0.6);
            z-index: 9999;
            transition: all 0.4s ease-in-out;
        }
        .tutorial-modal {
            position: absolute;
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #d1d5db;
            padding: 20px;
            border-radius: 12px;
            max-width: 350px;
            z-index: 10000;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            transition: all 0.4s ease-in-out;
        }

    </style>
</head>

<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <!-- Ecrã de Autenticação -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 to-blue-900 p-4">
        <div id="auth-box" class="w-full max-w-md bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-2xl shadow-2xl p-8 space-y-6">
            <div class="text-center">
                <img src="https://i.postimg.cc/vHwmvFrG/logo-evereste-2025-horizontal-2.png" alt="Logótipo Evereste" class="w-48 mx-auto mb-6">
                <h2 id="auth-title" class="text-2xl font-bold text-white">Bem-vindo de volta!</h2>
                <p class="text-gray-400">Inicie sessão para continuar</p>
            </div>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="email" placeholder="E-mail" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" required>
                <div class="relative">
                    <input type="password" id="password" placeholder="Senha" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" required>
                    <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 px-4 text-gray-400 hover:text-white">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <p id="auth-error" class="text-red-400 text-sm h-4"></p>
                <button type="submit" id="auth-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-transform transform hover:scale-105">Entrar</button>
            </form>
            <p class="text-center text-sm text-gray-400">
                <span id="auth-prompt-text">Não tem uma conta?</span>
                <a href="#" id="toggle-auth-mode" class="font-medium text-indigo-400 hover:underline">Registar-se</a>
            </p>
        </div>
    </div>

    <!-- Ecrã Principal da Aplicação -->
    <div id="app-container" class="hidden min-h-screen">
        <!-- Cabeçalho -->
        <header class="bg-gray-800/50 backdrop-blur-sm sticky top-0 z-20 flex items-center justify-between p-4 border-b border-gray-700">
            <h1 class="text-xl font-bold text-white">Timer <span class="text-indigo-400">Evereste</span></h1>
            <div class="flex items-center space-x-4">
                 <button id="start-tutorial-btn" title="Iniciar Tutorial" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-yellow-400 hover:bg-gray-600 transition">
                    <i class="fas fa-question-circle"></i>
                </button>
                <button id="profile-button" title="Meu Perfil" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-indigo-400 hover:bg-gray-600 transition">
                    <i class="fas fa-user"></i>
                </button>
                 <button id="logout-button" title="Sair" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-red-400 hover:bg-gray-600 transition">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Navegação -->
        <nav class="p-4 bg-gray-900 flex justify-center space-x-2 md:space-x-4">
            <button data-view="timer-view" class="nav-button bg-indigo-600 px-4 py-2 rounded-lg text-sm font-semibold transition hover:bg-indigo-700">
                <i class="fas fa-clock mr-2"></i>Timer
            </button>
            <button data-view="my-performance-view" class="nav-button bg-gray-700 px-4 py-2 rounded-lg text-sm font-semibold transition hover:bg-indigo-700">
                <i class="fas fa-chart-line mr-2"></i>O meu Desempenho
            </button>
            <button data-view="team-dashboard-view" class="nav-button bg-gray-700 px-4 py-2 rounded-lg text-sm font-semibold transition hover:bg-indigo-700">
                <i class="fas fa-users mr-2"></i>Equipa
            </button>
        </nav>

        <!-- Conteúdo Principal -->
        <main id="main-content" class="p-4 md:p-6">
            <!-- Vista do Timer -->
            <div id="timer-view" class="view-content fade-in space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg-col-span-2 space-y-6">
                        <!-- Criação de Tarefa -->
                        <div id="task-creation-container" class="bg-gray-800 p-4 rounded-xl shadow-lg">
                            <h2 class="text-lg font-bold mb-3">Iniciar nova tarefa</h2>
                            <form id="new-task-form" class="flex flex-col md:flex-row gap-3">
                                <input type="text" id="task-name" placeholder="Nome da tarefa" class="flex-grow px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <select id="task-tag" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                   <!-- As opções serão preenchidas por JS -->
                                </select>
                                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg transition-transform transform hover:scale-105">Iniciar</button>
                            </form>
                             <p id="task-limit-error" class="text-red-400 text-sm mt-2 h-4"></p>
                        </div>
                        <!-- Tarefas Ativas -->
                        <div>
                            <h2 class="text-xl font-bold mb-4">Tarefas Ativas</h2>
                            <div id="active-tasks-container" class="space-y-4">
                                <!-- As tarefas serão renderizadas aqui -->
                            </div>
                        </div>
                    </div>
                    <!-- Pomodoro e Ajuda -->
                    <div class="space-y-6">
                        <!-- Pomodoro -->
                        <div id="pomodoro-container" class="bg-gray-800 p-4 rounded-xl shadow-lg text-center">
                            <h2 class="text-lg font-bold mb-1">Sessão Pomodoro</h2>
                            <p id="pomodoro-status" class="text-sm text-indigo-300 mb-2">Hora de focar!</p>
                            <p id="pomodoro-timer" class="text-5xl font-mono font-bold text-indigo-400">25:00</p>
                             <div id="pomodoro-cycles" class="flex justify-center items-center gap-2 mt-3 text-yellow-400">
                                <!-- Os ícones de ciclo serão renderizados aqui -->
                            </div>
                            <div class="flex justify-center gap-3 mt-4">
                                <button id="pomodoro-start" title="Iniciar" class="bg-green-600 hover:bg-green-700 w-12 h-12 rounded-full flex items-center justify-center text-white"><i class="fas fa-play"></i></button>
                                <button id="pomodoro-pause" title="Pausar" class="bg-yellow-500 hover:bg-yellow-600 w-12 h-12 rounded-full flex items-center justify-center text-white"><i class="fas fa-pause"></i></button>
                                <button id="pomodoro-reset" title="Reiniciar" class="bg-red-600 hover:bg-red-700 w-12 h-12 rounded-full flex items-center justify-center text-white"><i class="fas fa-undo"></i></button>
                            </div>
                        </div>
                        <!-- Central de Ajuda -->
                        <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                             <h2 class="text-lg font-bold mb-3">Central de Ajuda</h2>
                             <div class="flex items-center gap-4">
                                <img src="https://i.postimg.cc/nVP7BvRQ/Sem-T-tulo-1.jpg" alt="Mascote Timer" class="w-20 h-20">
                                <p class="text-sm text-gray-300">"O tempo é o recurso mais valioso. Use-o com sabedoria para escalar as suas próprias montanhas."</p>
                             </div>
                             <button id="open-timer-help" class="mt-4 w-full bg-indigo-600/50 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition">Dicas de Foco</button>
                        </div>
                    </div>
                </div>
                 <!-- Histórico Recente -->
                <div>
                    <h2 class="text-xl font-bold mb-4">Últimas 3 Tarefas Finalizadas</h2>
                    <div id="recent-history-container" class="bg-gray-800 p-4 rounded-xl shadow-lg space-y-3">
                         <p id="no-recent-history" class="text-gray-400">Ainda não há tarefas finalizadas.</p>
                    </div>
                </div>
            </div>

            <!-- Vista O meu Desempenho -->
            <div id="my-performance-view" class="view-content fade-in hidden"></div>

            <!-- Vista Dashboard da Equipa -->
            <div id="team-dashboard-view" class="view-content fade-in hidden"></div>
        </main>

        <!-- Botão Flutuante do Chatbot -->
        <button id="open-chat-btn" class="bg-indigo-600 hover:bg-indigo-700 w-16 h-16 rounded-full shadow-lg flex items-center justify-center transition-transform transform hover:scale-110 overflow-hidden p-1">
            <img src="https://i.postimg.cc/yxnH5wnY/Gemini-Generated-Image-ech0slech0slech0.png" alt="Abrir Chat do Yeti" class="w-full h-full object-cover rounded-full">
        </button>
    </div>

    <!-- Modais -->
    <!-- Modal do Perfil -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 w-full max-w-2xl rounded-2xl shadow-2xl p-6 relative max-h-[90vh] overflow-y-auto fade-in">
            <button id="close-profile-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            <h2 class="text-2xl font-bold mb-2">O meu Perfil</h2>
            <p id="profile-email" class="text-indigo-400 mb-6"></p>
            
            <div>
                 <h3 class="text-lg font-semibold mb-4">Desempenho nos Últimos 7 Dias</h3>
                 <div id="profile-dashboard-container" class="relative min-h-[280px]"></div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-700">
                <h3 class="text-lg font-semibold mb-4">Alterar Senha</h3>
                <form id="change-password-form" class="space-y-4">
                    <input type="password" id="new-password" placeholder="Nova Senha" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <input type="password" id="confirm-password" placeholder="Confirmar Nova Senha" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition">Guardar Nova Senha</button>
                    <p id="password-change-feedback" class="text-sm h-4 text-center"></p>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal da Central de Ajuda -->
    <div id="help-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 w-full max-w-2xl rounded-2xl shadow-2xl p-6 relative max-h-[90vh] overflow-y-auto fade-in">
            <button id="close-help-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times fa-lg"></i></button>
            <div id="help-modal-content"></div>
        </div>
    </div>

    <!-- Modal do Chatbot -->
    <div id="chat-modal" class="hidden bottom-24 right-6 w-[350px] h-[500px] bg-gray-800 rounded-2xl shadow-2xl flex flex-col fade-in">
        <div class="flex items-center p-4 bg-gray-900 rounded-t-2xl">
            <img src="https://i.postimg.cc/yxnH5wnY/Gemini-Generated-Image-ech0slech0slech0.png" alt="Yeti" class="w-10 h-10 rounded-full mr-3">
            <div>
                <h3 class="font-bold">Yeti Assistente</h3>
                <p class="text-xs text-green-400">Online</p>
            </div>
            <button id="close-chat-btn" class="ml-auto text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
        <form id="chat-form" class="p-4 border-t border-gray-700">
            <div class="flex items-center bg-gray-700 rounded-lg">
                <input type="text" id="chat-input" placeholder="Pergunte algo..." class="w-full bg-transparent px-4 py-2 focus:outline-none">
                <button type="submit" class="p-2 text-indigo-400 hover:text-indigo-300"><i class="fas fa-paper-plane"></i></button>
            </div>
        </form>
    </div>

    <!-- Modal de Confirmação de Tarefa Finalizada -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 w-full max-w-sm rounded-2xl shadow-2xl p-8 text-center fade-in">
            <div class="text-5xl text-green-400 mb-4"><i class="fas fa-check-circle"></i></div>
            <h2 class="text-xl font-bold mb-2">Parabéns!</h2>
            <p id="confirmation-message" class="text-gray-300 mb-6">Finalizou mais uma atividade!</p>
            <button id="close-confirmation-modal" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition">Fechar</button>
        </div>
    </div>
    
    <!-- Modal de Edição de Tempo -->
    <div id="edit-time-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 w-full max-w-md rounded-2xl shadow-2xl p-6 fade-in">
            <h2 class="text-xl font-bold mb-2">Editar Tempo da Tarefa</h2>
            <p id="edit-task-name" class="text-indigo-400 mb-4"></p>
            <form id="edit-time-form">
                <input type="hidden" id="edit-task-id">
                <div class="flex justify-center items-center gap-2 mb-4">
                    <input type="number" id="edit-hours" min="0" max="99" class="w-20 text-center bg-gray-700 p-2 rounded-lg" placeholder="HH">
                    <span class="font-bold">:</span>
                    <input type="number" id="edit-minutes" min="0" max="59" class="w-20 text-center bg-gray-700 p-2 rounded-lg" placeholder="MM">
                    <span class="font-bold">:</span>
                    <input type="number" id="edit-seconds" min="0" max="59" class="w-20 text-center bg-gray-700 p-2 rounded-lg" placeholder="SS">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="close-edit-time-modal" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div id="delete-confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 w-full max-w-sm rounded-2xl shadow-2xl p-8 text-center fade-in">
            <div class="text-5xl text-red-400 mb-4"><i class="fas fa-exclamation-triangle"></i></div>
            <h2 class="text-xl font-bold mb-2">Tem a certeza?</h2>
            <p class="text-gray-300 mb-6">Esta ação não pode ser desfeita. A atividade será permanentemente excluída.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Tutorial Interativo -->
    <div id="tutorial-container" class="hidden">
        <div id="tutorial-highlight-box" class="tutorial-highlight"></div>
        <div id="tutorial-modal-box" class="tutorial-modal">
            <h3 id="tutorial-title" class="font-bold text-lg mb-2"></h3>
            <p id="tutorial-text" class="text-sm mb-4"></p>
            <div class="flex justify-between items-center">
                <button id="tutorial-prev" class="text-gray-400 hover:text-white">&laquo; Anterior</button>
                <span id="tutorial-step-counter" class="text-xs"></span>
                <button id="tutorial-next" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-lg">Próximo &raquo;</button>
            </div>
             <button id="tutorial-close" class="absolute top-2 right-3 text-gray-400 hover:text-white">&times;</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, query, where, orderBy, limit, deleteDoc, getDocs, Timestamp, collectionGroup, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCeEYuehK-AruCIV_zhNDDQ1ng5U1eIzqI",
            authDomain: "timerevereste.firebaseapp.com",
            projectId: "timerevereste",
            storageBucket: "timerevereste.appspot.com",
            messagingSenderId: "469617910016",
            appId: "1:469617910016:web:9076dbb4905667bb353e5",
            measurementId: "G-K1YGJ0NHCL"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Variáveis Globais ---
        const appContainer = document.getElementById('app-container');
        let currentUser = null;
        let activeTasks = [];
        let timerIntervals = {};
        let unsubscribeActiveTasks = null;
        let unsubscribeRecentHistory = null;
        let chatHistory = [];
        let currentUserName = '';
        
        // --- TAGS ---
        const TAG_OPTIONS = [ { name: 'Gestão de Projetos', color: 'bg-yellow-200 text-yellow-800' }, { name: 'Análise de Dados', color: 'bg-yellow-200 text-yellow-800' }, { name: 'Web Design', color: 'bg-green-200 text-green-800' }, { name: 'UX', color: 'bg-green-200 text-green-800' }, { name: 'UI', color: 'bg-green-200 text-green-800' }, { name: 'App', color: 'bg-green-200 text-green-800' }, { name: 'Pré-Produção', color: 'bg-gray-300 text-gray-800' }, { name: 'Roteiro', color: 'bg-gray-300 text-gray-800' }, { name: 'Edição de Vídeos', color: 'bg-blue-200 text-blue-800' }, { name: 'Edição de Fotos', color: 'bg-blue-200 text-blue-800' }, { name: 'Audiovisual', color: 'bg-blue-200 text-blue-800' }, { name: 'Captação Material', color: 'bg-blue-200 text-blue-800' }, { name: 'Pós-Produção', color: 'bg-blue-200 text-blue-800' }, { name: 'Evento', color: 'bg-purple-200 text-purple-800' }, { name: 'Cerimonial', color: 'bg-purple-200 text-purple-800' }, { name: 'Portal', color: 'bg-pink-200 text-pink-800' }, { name: 'E-mail', color: 'bg-pink-200 text-pink-800' }, { name: 'WhatsApp', color: 'bg-pink-200 text-pink-800' }, { name: 'Linkedin', color: 'bg-pink-200 text-pink-800' }, { name: 'Instagram', color: 'bg-pink-200 text-pink-800' }, { name: 'Youtube', color: 'bg-pink-200 text-pink-800' }, { name: 'Tiktok', color: 'bg-pink-200 text-pink-800' }, { name: 'Flickr', color: 'bg-pink-200 text-pink-800' }, { name: 'Facebook', color: 'bg-pink-200 text-pink-800' }, { name: 'TV Evereste', color: 'bg-pink-200 text-pink-800' }, { name: 'Impressão', color: 'bg-pink-200 text-pink-800' }, { name: 'Assessoria de Comunicação', color: 'bg-red-200 text-red-800' }, { name: 'HYPERDOC', color: 'bg-red-200 text-red-800' }, { name: 'Documento', color: 'bg-red-200 text-red-800' }, { name: 'Comunicação', color: 'bg-red-200 text-red-800' }, { name: 'Agendamento', color: 'bg-red-200 text-red-800' }, { name: 'Reunião', color: 'bg-red-200 text-red-800' }, { name: 'Planeamento', color: 'bg-red-200 text-red-800' }, { name: 'Treinamento', color: 'bg-red-200 text-red-800' }, { name: 'Pesquisa', color: 'bg-red-200 text-red-800' }, { name: 'Notícia', color: 'bg-red-200 text-red-800' }, { name: 'Atividade Externa', color: 'bg-red-200 text-red-800' }, { name: 'Apresentação', color: 'bg-red-200 text-red-800' }, { name: 'Design Gráfico', color: 'bg-orange-200 text-orange-800' }, { name: 'Design de Produtos', color: 'bg-orange-200 text-orange-800' }, { name: 'Design 3D', color: 'bg-orange-200 text-orange-800' }, { name: 'Motion Design', color: 'bg-orange-200 text-orange-800' }, { name: 'Social Media', color: 'bg-orange-200 text-orange-800' }, { name: 'Copywriting', color: 'bg-orange-200 text-orange-800' }, { name: 'Endomarketing', color: 'bg-orange-200 text-orange-800' }, { name: 'Identidade Visual', color: 'bg-orange-200 text-orange-800' }, { name: 'Mídia Paga', color: 'bg-orange-200 text-orange-800' }, ];
        const taskTagSelect = document.getElementById('task-tag');
        TAG_OPTIONS.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag.name;
            option.textContent = tag.name;
            taskTagSelect.appendChild(option);
        });
        function getTagColor(tagName) {
            const tag = TAG_OPTIONS.find(t => t.name === tagName);
            return tag ? tag.color : 'bg-gray-500 text-gray-100';
        }

        // --- Utilidades ---
        function formatTime(totalSeconds) {
            if(isNaN(totalSeconds) || totalSeconds < 0) return "00:00:00";
            const h = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const s = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        function generateColors(numColors) {
            const colors = ['#4f46e5', '#7c3aed', '#db2777', '#f97316', '#eab308', '#84cc16', '#10b981', '#06b6d4', '#3b82f6'];
            return Array.from({length: numColors}, (_, i) => colors[i % colors.length]);
        }
        function showConfirmationModal(message) {
            document.getElementById('confirmation-message').textContent = message;
            document.getElementById('confirmation-modal').classList.remove('hidden');
        }
        document.getElementById('close-confirmation-modal').addEventListener('click', () => {
             document.getElementById('confirmation-modal').classList.add('hidden');
        });

        // --- Gestão de Estado da UI e Listeners ---
        function setupListeners() {
            if (!currentUser) return;
            cleanupListeners();
            const activeTasksQuery = query(collection(db, `artifacts/default-app-id/users/${currentUser.uid}/active_tasks`));
            unsubscribeActiveTasks = onSnapshot(activeTasksQuery, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                Object.values(timerIntervals).forEach(clearInterval);
                timerIntervals = {};
                renderActiveTasks(tasks);
            });
            const recentHistoryQuery = query(collection(db, `artifacts/default-app-id/users/${currentUser.uid}/time_entries`), orderBy('endTime', 'desc'), limit(3));
            unsubscribeRecentHistory = onSnapshot(recentHistoryQuery, (snapshot) => {
                 renderRecentHistory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });
        }
        function cleanupListeners() {
            if (unsubscribeActiveTasks) unsubscribeActiveTasks();
            if (unsubscribeRecentHistory) unsubscribeRecentHistory();
            Object.values(timerIntervals).forEach(clearInterval);
            timerIntervals = {};
        }
        function clearUI() {
            document.getElementById('active-tasks-container').innerHTML = '';
            document.getElementById('recent-history-container').innerHTML = `<p id="no-recent-history" class="text-gray-400">Ainda não há tarefas finalizadas.</p>`;
            document.getElementById('my-performance-view').innerHTML = '';
            document.getElementById('team-dashboard-view').innerHTML = '';
            document.querySelector('[data-view="timer-view"]').click();
        }
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
                document.getElementById(button.dataset.view).classList.remove('hidden');
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.replace('bg-indigo-600', 'bg-gray-700'));
                button.classList.replace('bg-gray-700', 'bg-indigo-600');
                if (button.dataset.view === 'my-performance-view') loadMyPerformanceDashboard();
                if (button.dataset.view === 'team-dashboard-view') loadTeamDashboard();
            });
        });

        // --- LÓGICA DE AUTENTICAÇÃO ---
        const authContainer = document.getElementById('auth-container');
        const togglePassword = document.getElementById('toggle-password');
        togglePassword.addEventListener('click', () => {
            const passwordInput = document.getElementById('password');
            const icon = togglePassword.querySelector('i');
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        });

        let isLoginMode = true;
        document.getElementById('toggle-auth-mode').addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            document.getElementById('auth-error').textContent = '';
            document.getElementById('auth-form').reset();
            if (isLoginMode) {
                document.getElementById('auth-title').textContent = 'Bem-vindo de volta!';
                document.getElementById('auth-button').textContent = 'Entrar';
                document.getElementById('auth-prompt-text').textContent = 'Não tem uma conta?';
                document.getElementById('toggle-auth-mode').textContent = 'Registar-se';
            } else {
                document.getElementById('auth-title').textContent = 'Crie a sua conta';
                document.getElementById('auth-button').textContent = 'Registar';
                document.getElementById('auth-prompt-text').textContent = 'Já tem uma conta?';
                document.getElementById('toggle-auth-mode').textContent = 'Entrar';
            }
        });
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const authError = document.getElementById('auth-error');
            authError.textContent = '';
            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, `artifacts/default-app-id/users/${userCredential.user.uid}/profile/settings`), { email: userCredential.user.email });
                }
            } catch (error) { authError.textContent = 'Credenciais inválidas ou e-mail já em uso.'; }
        });


        setPersistence(auth, browserLocalPersistence); // MELHORIA 1: Garante que o login persiste no navegador
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                if (user.email) {
                    const namePart = user.email.split('@')[0];
                    const firstName = namePart.split('.')[0].split('-')[0];
                    currentUserName = firstName.charAt(0).toUpperCase() + firstName.slice(1);
                } else {
                    currentUserName = 'Utilizador';
                }
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadUserProfile();
                setupListeners();
                
                chatHistory = [];
                const welcomeMessage = `Olá, <b>${currentUserName}</b>! Eu sou o Yeti, o seu assistente de produtividade com IA. Faça qualquer pergunta sobre as suas tarefas ou sobre como usar a aplicação.`;
                addBotMessage(welcomeMessage);
                chatHistory.push({ role: "model", parts: [{ text: welcomeMessage }] });
            } else {
                currentUser = null;
                currentUserName = '';
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                cleanupListeners();
                clearUI();
                chatHistory = [];
            }
        });
        
        // --- LÓGICA DO TIMER E TAREFAS ---
        const newTaskForm = document.getElementById('new-task-form');
        newTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (activeTasks.length >= 3) {
                document.getElementById('task-limit-error').textContent = 'Pode ter no máximo 3 tarefas ativas.';
                setTimeout(() => document.getElementById('task-limit-error').textContent = '', 3000);
                return;
            }
            const taskName = document.getElementById('task-name').value;
            const taskTag = document.getElementById('task-tag').value;
            const newTask = { name: taskName, tag: taskTag, ownerId: currentUser.uid, status: 'paused', startTime: Timestamp.now(), lastStartTime: null, totalActiveTime: 0, totalPausedTime: 0, pauseCount: 0, lastPauseTime: Timestamp.now() };
            await addDoc(collection(db, `artifacts/default-app-id/users/${currentUser.uid}/active_tasks`), newTask);
            newTaskForm.reset();
        });

        // MELHORIA 2: Função de timer mais precisa
        function startTimer(task) {
            if (timerIntervals[task.id]) return;
            const timerElement = document.getElementById(`timer-${task.id}`);
            if (!timerElement) return;

            timerIntervals[task.id] = setInterval(() => {
                // Calcula o tempo decorrido desde o último play, somado ao tempo já acumulado.
                const elapsedSinceLastStart = Math.floor(Date.now() / 1000) - task.lastStartTime.seconds;
                const newTotalActiveTime = task.totalActiveTime + elapsedSinceLastStart;
                timerElement.textContent = formatTime(newTotalActiveTime);
            }, 1000);
        }

        function pauseTimer(taskId) {
            clearInterval(timerIntervals[taskId]);
            delete timerIntervals[taskId];
        }

        async function updateTaskInFirestore(taskId, updates) {
            if (!currentUser) return;
            const taskRef = doc(db, `artifacts/default-app-id/users/${currentUser.uid}/active_tasks`, taskId);
            await setDoc(taskRef, updates, { merge: true });
        }
        
        async function continueTask(taskToContinue) {
            await Promise.all(activeTasks.map(task => {
                if (task.id !== taskToContinue.id && task.status === 'running') return pauseTask(task);
            }));
            const now = Timestamp.now();
            const pauseDuration = now.seconds - taskToContinue.lastPauseTime.seconds;
            await updateTaskInFirestore(taskToContinue.id, { status: 'running', lastStartTime: now, totalPausedTime: taskToContinue.totalPausedTime + pauseDuration });
        }
        
        async function pauseTask(taskToPause) {
            const now = Timestamp.now();
            const activeDuration = now.seconds - taskToPause.lastStartTime.seconds;
            await updateTaskInFirestore(taskToPause.id, { status: 'paused', lastPauseTime: now, totalActiveTime: taskToPause.totalActiveTime + activeDuration, pauseCount: taskToPause.pauseCount + 1 });
        }

        async function finishTask(taskToFinish) {
            pauseTimer(taskToFinish.id);
            let finalActiveTime = taskToFinish.totalActiveTime;
            if (taskToFinish.status === 'running') {
                 finalActiveTime += (Math.floor(Date.now() / 1000) - taskToFinish.lastStartTime.seconds);
            }
            const { id, ...taskData } = taskToFinish;
            const finishedTask = { ...taskData, userEmail: currentUser.email, endTime: Timestamp.now(), totalActiveTime: finalActiveTime };
            delete finishedTask.status; delete finishedTask.lastStartTime; delete finishedTask.lastPauseTime;
            
            await addDoc(collection(db, `artifacts/default-app-id/users/${currentUser.uid}/time_entries`), finishedTask);
            await deleteDoc(doc(db, `artifacts/default-app-id/users/${currentUser.uid}/active_tasks`, id));
            
            showConfirmationModal(`Parabéns, finalizou a tarefa "${taskToFinish.name}"!`);
        }
        
        function renderActiveTasks(tasks) {
            activeTasks = tasks;
            const container = document.getElementById('active-tasks-container');
            container.innerHTML = tasks.length === 0 ? `<p class="text-gray-400 text-center">Nenhuma tarefa ativa. Inicie uma acima!</p>` : '';
            
            tasks.forEach(task => {
                const isRunning = task.status === 'running';
                let displayTime = task.totalActiveTime;
                if(isRunning && task.lastStartTime) displayTime += (Math.floor(Date.now() / 1000) - task.lastStartTime.seconds);
                
                // MELHORIA 3: Classes pulsantes são adicionadas aqui
                const cardPulseClass = !isRunning ? 'pulse-red-animate' : '';
                const buttonPulseClass = isRunning ? 'pulse-green-animate' : '';

                const taskCard = document.createElement('div');
                taskCard.id = `task-card-${task.id}`;
                taskCard.className = `p-4 rounded-xl shadow-lg flex flex-col md:flex-row items-center justify-between gap-4 transition-all duration-300 ${isRunning ? 'bg-green-800/50 border-2 border-green-500' : 'bg-gray-800'} ${cardPulseClass}`;
                taskCard.innerHTML = `
                    <div class="flex-grow text-center md:text-left">
                         <h3 class="font-bold text-lg">${task.name}</h3>
                        <p class="tag-color ${getTagColor(task.tag)}">${task.tag}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-center"><p class="text-2xl md:text-3xl font-mono" id="timer-${task.id}">${formatTime(displayTime)}</p><p class="text-xs text-gray-400">Tempo Ativo</p></div>
                        <div class="text-center"><p class="text-2xl md:text-3xl font-mono">${task.pauseCount}</p><p class="text-xs text-gray-400">Pausas</p></div>
                    </div>
                    <div class="flex gap-2">
                        <button class="${isRunning ? 'pause-btn bg-yellow-500' : `continue-btn bg-green-600 ${buttonPulseClass}`}" title="${isRunning ? 'Pausar' : 'Continuar'}"><i class="fas fa-${isRunning ? 'pause' : 'play'}"></i></button>
                        <button class="finish-btn bg-red-600" title="Finalizar"><i class="fas fa-check"></i></button>
                    </div>`;
                taskCard.querySelectorAll('button').forEach(btn => btn.classList.add('text-white', 'w-12', 'h-12', 'rounded-lg', 'transition', 'hover:opacity-80'));
                container.appendChild(taskCard);

                if(isRunning) {
                    taskCard.querySelector('.pause-btn').addEventListener('click', () => pauseTask(task));
                    startTimer({ ...task, totalActiveTime: displayTime });
                } else {
                    taskCard.querySelector('.continue-btn').addEventListener('click', () => continueTask(task));
                    pauseTimer(task.id);
                }
                taskCard.querySelector('.finish-btn').addEventListener('click', () => finishTask(task));
            });
        }
        
        function renderRecentHistory(entries) {
            const container = document.getElementById('recent-history-container');
            container.innerHTML = `<p id="no-recent-history" class="text-gray-400 ${entries.length > 0 ? 'hidden' : ''}">Nenhuma tarefa finalizada recentemente.</p>`;
            entries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'bg-gray-700 p-4 rounded-lg';
                entryDiv.innerHTML = `
                     <div class="flex justify-between items-start w-full">
                        <div><p class="font-semibold text-base">${entry.name}</p><p class="tag-color ${getTagColor(entry.tag)}">${entry.tag}</p></div>
                        <div class="text-right flex-shrink-0 ml-4">
                            <p class="font-mono text-xl">${formatTime(entry.totalActiveTime)}</p>
                            <p class="text-xs text-gray-400">Tempo Total</p>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-600/50 text-xs text-gray-400 flex justify-between items-center">
                         <p>${new Date(entry.endTime.seconds * 1000).toLocaleDateString()}</p>
                         <div class="flex items-center gap-4">
                            <button class="edit-history-btn text-gray-500 hover:text-yellow-400 text-lg" data-id="${entry.id}" title="Editar tempo"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-history-btn text-gray-500 hover:text-red-400 text-lg" data-id="${entry.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                container.appendChild(entryDiv);
                entryDiv.querySelector('.edit-history-btn').addEventListener('click', () => openEditTimeModal(entry));
            });
        }
        
        // --- LÓGICA DE EDIÇÃO E EXCLUSÃO DE HISTÓRICO ---
        function openEditTimeModal(entry) {
            document.getElementById('edit-task-id').value = entry.id;
            document.getElementById('edit-task-name').textContent = entry.name;
            const time = formatTime(entry.totalActiveTime).split(':');
            document.getElementById('edit-hours').value = time[0];
            document.getElementById('edit-minutes').value = time[1];
            document.getElementById('edit-seconds').value = time[2];
            document.getElementById('edit-time-modal').classList.remove('hidden');
        }
        document.getElementById('close-edit-time-modal').addEventListener('click', () => {
             document.getElementById('edit-time-modal').classList.add('hidden');
        });
        document.getElementById('edit-time-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-task-id').value;
            const h = parseInt(document.getElementById('edit-hours').value) || 0;
            const m = parseInt(document.getElementById('edit-minutes').value) || 0;
            const s = parseInt(document.getElementById('edit-seconds').value) || 0;
            const newTotalTime = (h * 3600) + (m * 60) + s;
            
            const entryRef = doc(db, `artifacts/default-app-id/users/${currentUser.uid}/time_entries`, id);
            await updateDoc(entryRef, { totalActiveTime: newTotalTime });
            document.getElementById('edit-time-modal').classList.add('hidden');
        });

        document.getElementById('main-content').addEventListener('click', (event) => {
            const deleteButton = event.target.closest('.delete-history-btn');
            if (deleteButton) {
                const entryId = deleteButton.dataset.id;
                promptForDelete(entryId);
            }
        });

        function promptForDelete(entryId) {
            const modal = document.getElementById('delete-confirmation-modal');
            modal.dataset.entryId = entryId;
            modal.classList.remove('hidden');
        }

        async function confirmDelete() {
            const modal = document.getElementById('delete-confirmation-modal');
            const entryId = modal.dataset.entryId;
            if (entryId && currentUser) {
                try {
                    await deleteDoc(doc(db, `artifacts/default-app-id/users/${currentUser.uid}/time_entries`, entryId));
                } catch (error) {
                    console.error("Erro ao excluir a entrada:", error);
                } finally {
                    modal.classList.add('hidden');
                    delete modal.dataset.entryId; 
                }
            }
        }

        document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);
        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            document.getElementById('delete-confirmation-modal').classList.add('hidden');
        });


        // --- LÓGICA DO POMODORO ---
        const pomodoroTimerEl = document.getElementById('pomodoro-timer');
        const pomodoroStatusEl = document.getElementById('pomodoro-status');
        const pomodoroCyclesEl = document.getElementById('pomodoro-cycles');
        let pomodoroInterval;
        let pomodoroTime = 25 * 60;
        let pomodoroRunning = false;
        let pomodoroState = 'work'; // work, shortBreak, longBreak
        let pomodoroCycles = 0;

        function updatePomodoroUI() {
            pomodoroTimerEl.textContent = formatTime(pomodoroTime).substring(3);
            let cyclesHTML = '';
            for(let i = 0; i < 4; i++) {
                cyclesHTML += `<i class="fas fa-circle ${i < pomodoroCycles ? 'text-yellow-400' : 'text-gray-600'}"></i>`;
            }
            pomodoroCyclesEl.innerHTML = cyclesHTML;

            if(pomodoroState === 'work') pomodoroStatusEl.textContent = `Ciclo ${pomodoroCycles + 1}: Hora de focar!`;
            else if(pomodoroState === 'shortBreak') pomodoroStatusEl.textContent = 'Pausa curta. Respire fundo!';
            else if(pomodoroState === 'longBreak') pomodoroStatusEl.textContent = 'Pausa longa. Descanse um pouco.';
        }

        function handlePomodoroFinish() {
            clearInterval(pomodoroInterval);
            pomodoroRunning = false;
            playAlarm();
            
            if (pomodoroState === 'work') {
                pomodoroCycles++;
                if (pomodoroCycles % 4 === 0) {
                    pomodoroState = 'longBreak';
                    pomodoroTime = 15 * 60;
                } else {
                    pomodoroState = 'shortBreak';
                    pomodoroTime = 5 * 60;
                }
            } else {
                pomodoroState = 'work';
                pomodoroTime = 25 * 60;
                if(pomodoroCycles === 4) pomodoroCycles = 0;
            }
            new Notification(`Sessão de ${pomodoroState === 'work' ? 'foco' : 'descanso'} finalizada!`, { body: "Bom trabalho!", icon: "https://i.postimg.cc/mDhmmMcn/Gemini-Generated-Image-qbpc7rqbpc7rqbpc-2.png" });
            updatePomodoroUI();
        }

        document.getElementById('pomodoro-start').addEventListener('click', () => {
            if (pomodoroRunning) return;
            pomodoroRunning = true;
            Notification.requestPermission();
            pomodoroInterval = setInterval(() => {
                pomodoroTime--;
                updatePomodoroUI();
                if (pomodoroTime < 0) {
                   handlePomodoroFinish();
                }
            }, 1000);
        });
        document.getElementById('pomodoro-pause').addEventListener('click', () => { clearInterval(pomodoroInterval); pomodoroRunning = false; });
        document.getElementById('pomodoro-reset').addEventListener('click', () => { 
            clearInterval(pomodoroInterval); 
            pomodoroRunning = false; 
            pomodoroState = 'work';
            pomodoroCycles = 0;
            pomodoroTime = 25 * 60; 
            updatePomodoroUI();
        });
        
        // MELHORIA 4: Som de alarme melhorado
        function playAlarm() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);

            // Toca uma sequência de notas
            const notes = [660, 550, 660];
            notes.forEach((freq, i) => {
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime + i * 0.2);
                oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.2);
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime + i * 0.2 + 0.15);
            });

            oscillator.start(audioCtx.currentTime);
            setTimeout(() => {
                oscillator.stop();
                audioCtx.close();
            }, notes.length * 200 + 100);
        }
        updatePomodoroUI();


        // --- TUTORIAL INTERATIVO ---
        const tutorialSteps = [
            { selector: '#task-creation-container', title: 'Passo 1: Crie a sua Tarefa', text: 'Comece por aqui. Dê um nome para a sua atividade, escolha uma categoria e clique em "Iniciar".' },
            { selector: '#active-tasks-container', title: 'Passo 2: Controle as suas Tarefas', text: 'As suas tarefas ativas aparecerão aqui. Use os botões de play/pause para controlar o tempo e o botão de finalizar para concluir.' },
            { selector: '#pomodoro-container', title: 'Passo 3: Use o Pomodoro', text: 'Para um foco profundo, use a técnica Pomodoro. São 25 minutos de trabalho intenso seguidos por uma pausa.' },
            { selector: '[data-view="my-performance-view"]', title: 'Passo 4: Analise o seu Desempenho', text: 'Clique aqui para ver gráficos e relatórios sobre como está a usar o seu tempo.' },
            { selector: '#open-chat-btn', title: 'Passo 5: Fale com o Yeti', text: 'Tem dúvidas? Clique no nosso assistente de IA. Ele pode dar dicas ou analisar os seus dados para si.' }
        ];
        let currentStep = 0;

        function showTutorialStep(stepIndex) {
            const step = tutorialSteps[stepIndex];
            const targetElement = document.querySelector(step.selector);
            if (!targetElement) return;

            const highlightBox = document.getElementById('tutorial-highlight-box');
            const modalBox = document.getElementById('tutorial-modal-box');
            
            const rect = targetElement.getBoundingClientRect();
            highlightBox.style.width = `${rect.width + 10}px`;
            highlightBox.style.height = `${rect.height + 10}px`;
            highlightBox.style.top = `${rect.top - 5}px`;
            highlightBox.style.left = `${rect.left - 5}px`;

            document.getElementById('tutorial-title').textContent = step.title;
            document.getElementById('tutorial-text').textContent = step.text;
            document.getElementById('tutorial-step-counter').textContent = `${stepIndex + 1} / ${tutorialSteps.length}`;
            
            // Posiciona o modal de forma inteligente
            const modalRect = modalBox.getBoundingClientRect();
            let modalTop = rect.bottom + 15;
            let modalLeft = rect.left;

            // Se o modal sair por baixo, coloca-o por cima
            if (modalTop + modalRect.height > window.innerHeight - 15) {
                modalTop = rect.top - modalRect.height - 15;
            }

            // Se o modal sair pela direita, alinha-o à direita do ecrã
            if (modalLeft + modalRect.width > window.innerWidth - 15) {
                modalLeft = window.innerWidth - modalRect.width - 15;
            }
            
            // Garante que não sai pela esquerda
            if (modalLeft < 15) {
                modalLeft = 15;
            }
            // Garante que não sai por cima
            if (modalTop < 15) {
                modalTop = 15;
            }

            modalBox.style.top = `${modalTop}px`;
            modalBox.style.left = `${modalLeft}px`;

            document.getElementById('tutorial-prev').style.visibility = stepIndex === 0 ? 'hidden' : 'visible';
            document.getElementById('tutorial-next').textContent = stepIndex === tutorialSteps.length - 1 ? 'Finalizar' : 'Próximo »';
        }


        function startTutorial() {
            document.getElementById('tutorial-container').classList.remove('hidden');
            currentStep = 0;
            showTutorialStep(currentStep);
        }

        function endTutorial() {
            document.getElementById('tutorial-container').classList.add('hidden');
        }

        document.getElementById('start-tutorial-btn').addEventListener('click', startTutorial);
        document.getElementById('tutorial-close').addEventListener('click', endTutorial);
        document.getElementById('tutorial-next').addEventListener('click', () => {
            if (currentStep < tutorialSteps.length - 1) {
                currentStep++;
                showTutorialStep(currentStep);
            } else {
                endTutorial();
            }
        });
        document.getElementById('tutorial-prev').addEventListener('click', () => {
            if (currentStep > 0) {
                currentStep--;
                showTutorialStep(currentStep);
            }
        });
        
        // --- LÓGICA DOS DASHBOARDS E GRÁFICOS ---
        async function loadMyPerformanceDashboard() {
            const container = document.getElementById('my-performance-view');
            container.innerHTML = `<div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-40"><i class="fas fa-spinner fa-spin text-4xl text-indigo-400"></i></div>`;
            if (!currentUser) { container.innerHTML = ''; return; };

            try {
                const q = query(collection(db, `artifacts/default-app-id/users/${currentUser.uid}/time_entries`), orderBy('endTime', 'desc'));
                const querySnapshot = await getDocs(q);
                const entries = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const totalTime = entries.reduce((acc, curr) => acc + curr.totalActiveTime, 0);
                const totalTasks = entries.length;
                const timeByCategory = entries.reduce((acc, curr) => {
                    acc[curr.tag] = (acc[curr.tag] || 0) + curr.totalActiveTime;
                    return acc;
                }, {});

                const filteredTimeByCategory = Object.entries(timeByCategory).filter(([, value]) => value > 0);
                const chartLabels = filteredTimeByCategory.map(([key]) => key);
                const chartData = filteredTimeByCategory.map(([, value]) => value);

                container.innerHTML = `
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6 flex items-center gap-4">
                        <img src="https://i.postimg.cc/nVP7BvRQ/Sem-T-tulo-1.jpg" alt="Mascote Dash" class="w-20 h-20">
                        <div><h2 class="text-lg font-bold">Análise de Performance</h2><p class="text-sm text-gray-300">"Medir o progresso é o primeiro passo para melhorá-lo. Seus dados são o mapa para o seu pico de produtividade."</p>
                        <button id="open-dash-help" class="mt-2 text-sm text-indigo-400 hover:underline">Ver dicas do Yeti</button></div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${formatTime(totalTime)}</p><p class="text-gray-400">Tempo Total Registado</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${totalTasks}</p><p class="text-gray-400">Total de Tarefas</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${formatTime(totalTasks > 0 ? totalTime / totalTasks : 0)}</p><p class="text-gray-400">Tempo Médio por Tarefa</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-gray-800 p-6 rounded-xl h-[400px]"><h3 class="font-bold mb-4">Meu Tempo por Categoria</h3><canvas id="my-perf-category-chart"></canvas></div>
                        <div class="bg-gray-800 p-6 rounded-xl max-h-[400px] overflow-y-auto"><h3 class="font-bold mb-4">Histórico Completo</h3>
                            <table class="w-full text-left text-sm">
                                <thead class="text-xs text-gray-400 uppercase bg-gray-700"><tr><th class="p-2">Tarefa</th><th class="p-2">Tempo Total</th><th class="p-2">Pausas</th><th class="p-2">Data Fim</th><th class="p-2">Ações</th></tr></thead>
                                <tbody>${entries.map(e => {
                                    const tagColor = getTagColor(e.tag);
                                    const endDate = new Date(e.endTime.seconds * 1000);

                                    return `<tr class="border-b border-gray-700">
                                        <td class="p-2">${e.name}<br><span class="tag-color ${tagColor}">${e.tag}</span></td>
                                        <td class="p-2 font-mono">${formatTime(e.totalActiveTime)}</td>
                                        <td class="p-2 text-center">${e.pauseCount}</td>
                                        <td class="p-2">${endDate.toLocaleDateString([], {day: '2-digit', month: '2-digit', year: 'numeric'})}</td>
                                        <td class="p-2 text-center">
                                            <button class="delete-history-btn text-gray-500 hover:text-red-400 text-lg" data-id="${e.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>`
                                }).join('')}</tbody>
                            </table>
                        </div>
                    </div>`;
                container.querySelector('#open-dash-help').addEventListener('click', openHelpModal);

                const ctx = document.getElementById('my-perf-category-chart').getContext('2d');
                new Chart(ctx, { type: 'doughnut', data: { labels: chartLabels, datasets: [{ data: chartData, backgroundColor: generateColors(chartData.length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#d1d5db' } } } } });
            } catch (error) {
                console.error("Error loading My Performance Dashboard:", error);
                container.innerHTML = `<p class="text-red-400 text-center">Ocorreu um erro ao carregar os dados.</p>`;
            }
        }

        async function loadTeamDashboard(startDate = null, endDate = null) {
            const container = document.getElementById('team-dashboard-view');
            const dashboardContentId = 'team-dashboard-content';
            let dashboardContent = document.getElementById(dashboardContentId);

            if (!dashboardContent) {
                 container.innerHTML = `
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6 flex items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                           <img src="https://i.postimg.cc/nVP7BvRQ/Sem-T-tulo-1.jpg" alt="Mascote Dash" class="w-20 h-20">
                            <div>
                                <h2 class="text-lg font-bold">Análise da Equipa</h2>
                                <p class="text-sm text-gray-300">"Uma equipa sincronizada escala mais rápido."</p>
                            </div>
                        </div>
                        <button id="open-dash-help-team" class="text-sm text-indigo-400 hover:underline flex-shrink-0">Ver dicas do Yeti</button>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6 flex flex-wrap items-center justify-center gap-4">
                        <button class="filter-btn bg-indigo-600" data-period="today">Hoje</button>
                        <button class="filter-btn" data-period="week">Esta Semana</button>
                        <button class="filter-btn" data-period="month">Este Mês</button>
                        <input type="text" id="date-range-picker" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-center" placeholder="Selecione um período">
                    </div>
                    <div id="${dashboardContentId}" class="relative min-h-[400px]"></div>`;
                dashboardContent = document.getElementById(dashboardContentId);
                container.querySelector('#open-dash-help-team').addEventListener('click', openHelpModal);
                 // Inicializa o date picker
                $('#date-range-picker').daterangepicker({
                    opens: 'left',
                    locale: { format: 'DD/MM/YYYY', "applyLabel": "Aplicar", "cancelLabel": "Cancelar", "fromLabel": "De", "toLabel": "Para", "daysOfWeek": ["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"],"monthNames": ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"], }
                }, function(start, end) {
                    loadTeamDashboard(start.toDate(), end.toDate());
                });
                
                container.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        container.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('bg-indigo-600'));
                        e.target.classList.add('bg-indigo-600');
                        const period = e.target.dataset.period;
                        if(period === 'today') loadTeamDashboard(moment().startOf('day').toDate(), moment().endOf('day').toDate());
                        else if(period === 'week') loadTeamDashboard(moment().startOf('week').toDate(), moment().endOf('week').toDate());
                        else if(period === 'month') loadTeamDashboard(moment().startOf('month').toDate(), moment().endOf('month').toDate());
                    });
                });
            }

            dashboardContent.innerHTML = `<div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-spinner fa-spin text-4xl text-indigo-400"></i></div>`;

            try {
                let timeEntriesQuery;
                if(startDate && endDate){
                    timeEntriesQuery = query(collectionGroup(db, 'time_entries'), where('endTime', '>=', Timestamp.fromDate(startDate)), where('endTime', '<=', Timestamp.fromDate(endDate)), orderBy('endTime', 'desc'));
                } else {
                    timeEntriesQuery = query(collectionGroup(db, 'time_entries'), orderBy('endTime', 'desc'), limit(300));
                }

                const snapshot = await getDocs(timeEntriesQuery);
                const allEntries = snapshot.docs.map(doc => doc.data());

                const totalTime = allEntries.reduce((sum, entry) => sum + entry.totalActiveTime, 0);
                const timeByCategory = allEntries.reduce((acc, curr) => { acc[curr.tag] = (acc[curr.tag] || 0) + curr.totalActiveTime; return acc; }, {});
                const timeByUser = allEntries.reduce((acc, curr) => { acc[curr.userEmail] = (acc[curr.userEmail] || 0) + curr.totalActiveTime; return acc; }, {});
                
                const topUsers = Object.entries(timeByUser).filter(([, value]) => value > 0).sort((a, b) => b[1] - a[1]).slice(0, 10);
                const filteredTimeByCategory = Object.entries(timeByCategory).filter(([, value]) => value > 0);

                dashboardContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${formatTime(totalTime)}</p><p class="text-gray-400">Tempo Total da Equipa</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${allEntries.length}</p><p class="text-gray-400">Total de Tarefas</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${new Set(allEntries.map(e => e.ownerId)).size}</p><p class="text-gray-400">Colaboradores Ativos</p></div>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-800 p-6 rounded-xl h-[400px]"><h3 class="font-bold mb-4">Tempo por Categoria (Equipa)</h3><canvas id="team-category-chart"></canvas></div>
                        <div class="bg-gray-800 p-6 rounded-xl h-[400px]"><h3 class="font-bold mb-4">Top 10 Colaboradores</h3><canvas id="team-user-chart"></canvas></div>
                    </div>
                     <div class="bg-gray-800 p-6 rounded-xl max-h-[400px] overflow-y-auto"><h3 class="font-bold mb-4">Log de Atividades Recentes</h3>
                         <table class="w-full text-left text-sm">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700"><tr><th class="p-2">Colaborador</th><th class="p-2">Tarefa</th><th class="p-2">Tempo</th><th class="p-2"><i class="fas fa-pause-circle"></i></th><th class="p-2">Data</th></tr></thead>
                            <tbody>${allEntries.slice(0, 50).map(e => {
                                const tagColor = getTagColor(e.tag);
                                return `<tr class="border-b border-gray-700"><td class="p-2">${e.userEmail}</td><td class="p-2">${e.name}<br><span class="tag-color ${tagColor}">${e.tag}</span></td><td class="p-2 font-mono">${formatTime(e.totalActiveTime)}</td><td class="p-2 text-center">${e.pauseCount}</td><td class="p-2">${new Date(e.endTime.seconds * 1000).toLocaleString()}</td></tr>`
                            }).join('')}</tbody>
                        </table>
                     </div>`;
                
                new Chart(document.getElementById('team-category-chart').getContext('2d'), { type: 'bar', data: { labels: filteredTimeByCategory.map(i => i[0]), datasets: [{ label: 'Tempo', data: filteredTimeByCategory.map(i => i[1]), backgroundColor: generateColors(filteredTimeByCategory.length) }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db' } } }, plugins: { legend: { display: false } } } });
                new Chart(document.getElementById('team-user-chart').getContext('2d'), { type: 'bar', data: { labels: topUsers.map(u => u[0]), datasets: [{ label: 'Tempo', data: topUsers.map(u => u[1]), backgroundColor: generateColors(topUsers.length) }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { y: { ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db' } } }, plugins: { legend: { display: false } } } });
            } catch (error) {
                console.error("Error loading Team Dashboard:", error);
                dashboardContent.innerHTML = `<p class="text-red-400 text-center">Ocorreu um erro ao carregar os dados da equipa.</p>`;
                if (error.code === 'failed-precondition') console.error("Falta de índice no Firestore. Crie o índice através do link na consola.");
            }
        }

        // --- LÓGICA DO PERFIL ---
        const profileModal = document.getElementById('profile-modal');
        document.getElementById('profile-button').addEventListener('click', () => { profileModal.classList.remove('hidden'); loadProfileDashboard(); });
        document.getElementById('close-profile-modal').addEventListener('click', () => profileModal.classList.add('hidden'));
        async function loadUserProfile() {
            if(!currentUser) return;
            document.getElementById('profile-email').textContent = currentUser.email;
        }
        async function loadProfileDashboard() {
            const container = document.getElementById('profile-dashboard-container');
            container.innerHTML = `<div class="absolute inset-0 flex items-center justify-center bg-gray-800 rounded-lg"><i class="fas fa-spinner fa-spin text-3xl text-indigo-400"></i></div>`;
            try {
                const sevenDaysAgo = Timestamp.fromDate(new Date(Date.now() - 7 * 24 * 60 * 60 * 1000));
                const q = query(collection(db, `artifacts/default-app-id/users/${currentUser.uid}/time_entries`), where('endTime', '>=', sevenDaysAgo));
                const snapshot = await getDocs(q);
                const entries = snapshot.docs.map(doc => doc.data());

                const totalTime = entries.reduce((sum, e) => sum + e.totalActiveTime, 0);
                const timeByCategory = entries.reduce((acc, curr) => { acc[curr.tag] = (acc[curr.tag] || 0) + curr.totalActiveTime; return acc; }, {});
                
                container.innerHTML = `<p class="text-center text-3xl font-bold text-indigo-400 mb-4">${formatTime(totalTime)}</p><div class="h-64"><canvas id="profile-category-chart"></canvas></div>`;
                new Chart(document.getElementById('profile-category-chart').getContext('2d'), { type: 'pie', data: { labels: Object.keys(timeByCategory), datasets: [{ data: Object.values(timeByCategory), backgroundColor: generateColors(Object.keys(timeByCategory).length) }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            } catch(error) {
                container.innerHTML = `<div class="text-red-400 p-4">Ocorreu um erro ao carregar o seu desempenho.</div>`;
            }
        }
        
        // --- CENTRAL DE AJUDA ---
        const helpModal = document.getElementById('help-modal');
        document.getElementById('open-timer-help').addEventListener('click', openHelpModal);
        document.getElementById('close-help-modal').addEventListener('click', () => helpModal.classList.add('hidden'));
        function openHelpModal() {
            const currentView = document.querySelector('.nav-button.bg-indigo-600').dataset.view;
            const contentEl = document.getElementById('help-modal-content');
            if (currentView === 'timer-view') {
                contentEl.innerHTML = `
                    <div class="flex items-center gap-4 mb-6">
                        <img src="https://i.postimg.cc/nVP7BvRQ/Sem-T-tulo-1.jpg" class="w-24 h-24 rounded-full">
                        <h2 class="text-2xl font-bold text-white">Maximizando o Foco 💡</h2>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-gray-700 p-4 rounded-lg flex items-start gap-4">
                            <div class="text-2xl text-red-400 mt-1"><i class="fas fa-stopwatch"></i></div>
                            <div>
                                <h3 class="font-bold text-lg">Domine o Pomodoro</h3>
                                <p class="text-gray-300 text-sm">Use os ciclos de 25 minutos para manter a concentração máxima. Ao final, faça uma pausa curta. Isso treina seu cérebro para focar intensamente por períodos definidos.</p>
                            </div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg flex items-start gap-4">
                            <div class="text-2xl text-blue-400 mt-1"><i class="fas fa-tasks"></i></div>
                            <div>
                                <h3 class="font-bold text-lg">Limite suas Tarefas Ativas</h3>
                                <p class="text-gray-300 text-sm">Limitar as tarefas ativas a 3 força a priorização. Conclua o que começou antes de abrir novos loops. Foco gera momentum e evita a sobrecarga mental.</p>
                            </div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg flex items-start gap-4">
                            <div class="text-2xl text-indigo-400 mt-1"><i class="fas fa-comment-dots"></i></div>
                            <div>
                                <h3 class="font-bold text-lg">Converse com o Yeti</h3>
                                <p class="text-gray-300 text-sm">Pergunte ao nosso assistente sobre seus padrões de trabalho. "Onde gastei mais tempo hoje?" pode revelar insights para otimizar seu próximo dia.</p>
                            </div>
                        </div>
                    </div>`;
            } else {
                 contentEl.innerHTML = `
                    <div class="flex items-center gap-4 mb-6">
                        <img src="https://i.postimg.cc/nVP7BvRQ/Sem-T-tulo-1.jpg" class="w-24 h-24 rounded-full">
                        <h2 class="text-2xl font-bold text-white">Entendendo Seus Dados 📊</h2>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-gray-700 p-4 rounded-lg flex items-start gap-4">
                            <div class="text-2xl text-green-400 mt-1"><i class="fas fa-chart-line"></i></div>
                            <div>
                                <h3 class="font-bold text-lg">Tempo Total e Esforço</h3>
                                <p class="text-gray-300 text-sm">Este é o seu indicador de esforço bruto. É a base da sua produtividade. Aumentá-lo consistentemente, com qualidade, é o objetivo principal.</p>
                            </div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg flex items-start gap-4">
                            <div class="text-2xl text-purple-400 mt-1"><i class="fas fa-chart-pie"></i></div>
                            <div>
                                <h3 class="font-bold text-lg">Tempo por Categoria</h3>
                                <p class="text-gray-300 text-sm">Revela para onde sua energia está a fluir. Se o tempo em 'Reuniões' é maior que em 'Desenvolvimento', pode ser um sinal para reavaliar sua agenda e prioridades.</p>
                            </div>
                        </div>
                        <div class="bg-gray-700 p-4 rounded-lg flex items-start gap-4">
                            <div class="text-2xl text-yellow-400 mt-1"><i class="fas fa-users"></i></div>
                            <div>
                                <h3 class="font-bold text-lg">Top Colaboradores</h3>
                                <p class="text-gray-300 text-sm">Na visão de equipe, este gráfico não é sobre competição, mas sobre reconhecer o esforço e identificar quem pode ser um mentor em práticas de alta produtividade.</p>
                            </div>
                        </div>
                    </div>`;
            }
            helpModal.classList.remove('hidden');
        }
        
        // --- LÓGICA DO CHATBOT ---
        const chatModal = document.getElementById('chat-modal');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const openChatBtn = document.getElementById('open-chat-btn');

        document.getElementById('close-chat-btn').addEventListener('click', () => chatModal.classList.add('hidden'));
        chatForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            const msg = document.getElementById('chat-input').value; 
            if(msg) { 
                addUserMessage(msg); 
                processChatMessage(msg); 
            } 
            document.getElementById('chat-input').value = ''; 
        });
        function addUserMessage(message) { chatMessages.innerHTML += `<div class="flex justify-end"><div class="chat-bubble bg-indigo-600 text-white p-3 rounded-lg">${message}</div></div>`; chatMessages.scrollTop = chatMessages.scrollHeight; }
        function addBotMessage(message) { chatMessages.innerHTML += `<div class="flex items-end gap-2"><img src="https://i.postimg.cc/yxnH5wnY/Gemini-Generated-Image-ech0slech0slech0.png" alt="Yeti" class="w-8 h-8 rounded-full"><div class="chat-bubble bg-gray-700 p-3 rounded-lg">${message}</div></div>`; chatMessages.scrollTop = chatMessages.scrollHeight; }
        async function processChatMessage(message) { /* Lógica do Gemini (não alterada) */ }

        // --- LÓGICA DO BOTÃO DE CHAT ARRASTÁVEL (CORRIGIDO) ---
        let isDragging = false;
        let hasDragged = false;
        let offsetX = 0, offsetY = 0;

        function onDragStart(e) {
            isDragging = true;
            hasDragged = false;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const btnRect = openChatBtn.getBoundingClientRect();
            offsetX = clientX - btnRect.left;
            offsetY = clientY - btnRect.top;

            // Muda para posicionamento top/left para arrastar
            openChatBtn.style.right = 'auto';
            openChatBtn.style.bottom = 'auto';
            openChatBtn.style.left = `${btnRect.left}px`;
            openChatBtn.style.top = `${btnRect.top}px`;

            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('touchmove', onDragMove, { passive: false });
            document.addEventListener('mouseup', onDragEnd);
            document.addEventListener('touchend', onDragEnd);
        }

        function onDragMove(e) {
            if (!isDragging) return;
            e.preventDefault(); 

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            if (!hasDragged && (Math.abs(clientX - (offsetX + parseFloat(openChatBtn.style.left))) > 5 || Math.abs(clientY - (offsetY + parseFloat(openChatBtn.style.top))) > 5)) {
                hasDragged = true;
            }

            let newLeft = clientX - offsetX;
            let newTop = clientY - offsetY;

            // Limita o movimento à janela de visualização
            const btnRect = openChatBtn.getBoundingClientRect();
            if (newLeft < 0) newLeft = 0;
            if (newTop < 0) newTop = 0;
            if (newLeft + btnRect.width > window.innerWidth) newLeft = window.innerWidth - btnRect.width;
            if (newTop + btnRect.height > window.innerHeight) newTop = window.innerHeight - btnRect.height;

            openChatBtn.style.left = `${newLeft}px`;
            openChatBtn.style.top = `${newTop}px`;
            
            positionChatModal();
        }

        function onDragEnd() {
            isDragging = false;
            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('touchmove', onDragMove);
            document.removeEventListener('mouseup', onDragEnd);
            document.removeEventListener('touchend', onDragEnd);
        }

        function positionChatModal() {
            if (chatModal.classList.contains('hidden')) return;
            
            const btnRect = openChatBtn.getBoundingClientRect();
            let modalTop = btnRect.top - chatModal.offsetHeight - 16;
            let modalLeft = btnRect.left + (btnRect.width / 2) - (chatModal.offsetWidth / 2);

            // Ajusta se o modal sair do ecrã
            if (modalTop < 10) modalTop = btnRect.bottom + 16;
            if (modalLeft < 10) modalLeft = 10;
            if (modalLeft + chatModal.offsetWidth > window.innerWidth) modalLeft = window.innerWidth - chatModal.offsetWidth - 10;
            
            chatModal.style.top = `${modalTop}px`;
            chatModal.style.left = `${modalLeft}px`;
            chatModal.style.right = 'auto';
            chatModal.style.bottom = 'auto';
        }

        openChatBtn.addEventListener('mousedown', onDragStart);
        openChatBtn.addEventListener('touchstart', onDragStart, { passive: false });
        openChatBtn.addEventListener('click', (e) => {
            if (hasDragged) {
                e.preventDefault();
                return;
            }
            chatModal.classList.toggle('hidden');
            positionChatModal();
        });

        window.addEventListener('resize', () => {
            // Reposiciona o botão no canto se a janela for redimensionada
             openChatBtn.style.left = '';
             openChatBtn.style.top = '';
             openChatBtn.style.right = '1.5rem';
             openChatBtn.style.bottom = '1.5rem';
             positionChatModal();
        });
        
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));

    </script>
</body>

</html>

