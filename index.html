<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Evereste</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* Estilo para a barra de scroll */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6366f1;
        }

        /* Animação de fade-in */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <!-- Ecrã de Autenticação -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 to-blue-900 p-4">
        <div id="auth-box" class="w-full max-w-md bg-gray-800 bg-opacity-50 backdrop-blur-sm rounded-2xl shadow-2xl p-8 space-y-6">
            <div class="text-center">
                <img src="https://i.postimg.cc/vHwmvFrG/logo-evereste-2025-horizontal-2.png" alt="Logótipo Evereste" class="w-48 mx-auto mb-6">
                <h2 id="auth-title" class="text-2xl font-bold text-white">Bem-vindo de volta!</h2>
                <p class="text-gray-400">Inicie sessão para continuar</p>
            </div>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="email" placeholder="E-mail" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" required>
                <input type="password" id="password" placeholder="Senha" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" required>
                <p id="auth-error" class="text-red-400 text-sm h-4"></p>
                <button type="submit" id="auth-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-transform transform hover:scale-105">Entrar</button>
            </form>
            <p class="text-center text-sm text-gray-400">
                <span id="auth-prompt-text">Não tem uma conta?</span>
                <a href="#" id="toggle-auth-mode" class="font-medium text-indigo-400 hover:underline">Registrar-se</a>
            </p>
        </div>
    </div>

    <!-- Ecrã Principal da Aplicação -->
    <div id="app-container" class="hidden min-h-screen">
        <!-- Cabeçalho -->
        <header class="bg-gray-800/50 backdrop-blur-sm sticky top-0 z-20 flex items-center justify-between p-4 border-b border-gray-700">
            <h1 class="text-xl font-bold text-white">Timer <span class="text-indigo-400">Evereste</span></h1>
            <div class="flex items-center space-x-4">
                <button id="profile-button" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-indigo-400 hover:bg-gray-600 transition">
                    <i class="fas fa-user"></i>
                </button>
                 <button id="logout-button" title="Sair" class="w-10 h-10 bg-gray-700 rounded-full flex items-center justify-center text-red-400 hover:bg-gray-600 transition">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Navegação -->
        <nav class="p-4 bg-gray-900 flex justify-center space-x-2 md:space-x-4">
            <button data-view="timer-view" class="nav-button bg-indigo-600 px-4 py-2 rounded-lg text-sm font-semibold transition hover:bg-indigo-700">
                <i class="fas fa-clock mr-2"></i>Timer
            </button>
            <button data-view="my-performance-view" class="nav-button bg-gray-700 px-4 py-2 rounded-lg text-sm font-semibold transition hover:bg-indigo-700">
                <i class="fas fa-chart-line mr-2"></i>Meu Desempenho
            </button>
            <button data-view="team-dashboard-view" class="nav-button bg-gray-700 px-4 py-2 rounded-lg text-sm font-semibold transition hover:bg-indigo-700">
                <i class="fas fa-users mr-2"></i>Equipe
            </button>
        </nav>

        <!-- Conteúdo Principal -->
        <main id="main-content" class="p-4 md:p-6">
            <!-- Vista do Timer -->
            <div id="timer-view" class="view-content fade-in space-y-6">
                <!-- Criação de Tarefa -->
                <div id="task-creation-container" class="bg-gray-800 p-4 rounded-xl shadow-lg">
                    <h2 class="text-lg font-bold mb-3">Iniciar nova tarefa</h2>
                    <form id="new-task-form" class="flex flex-col md:flex-row gap-3">
                        <input type="text" id="task-name" placeholder="Nome da tarefa" class="flex-grow px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <select id="task-tag" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                           <!-- Options will be populated by JS -->
                        </select>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-5 rounded-lg transition-transform transform hover:scale-105">Iniciar</button>
                    </form>
                     <p id="task-limit-error" class="text-red-400 text-sm mt-2 h-4"></p>
                </div>
                <!-- Tarefas Ativas -->
                <div>
                    <h2 class="text-xl font-bold mb-4">Tarefas Ativas</h2>
                    <div id="active-tasks-container" class="space-y-4">
                        <!-- Tasks will be rendered here -->
                    </div>
                </div>
                <!-- Histórico Recente -->
                <div>
                    <h2 class="text-xl font-bold mb-4">Últimas 5 Tarefas Finalizadas</h2>
                    <div id="recent-history-container" class="bg-gray-800 p-4 rounded-xl shadow-lg space-y-3">
                        <!-- Recent history items will be rendered here -->
                         <p id="no-recent-history" class="text-gray-400">Ainda não há tarefas finalizadas.</p>
                    </div>
                </div>
            </div>

            <!-- Vista Meu Desempenho -->
            <div id="my-performance-view" class="view-content fade-in hidden">
                <!-- Content will be injected by JS -->
            </div>

            <!-- Vista Dashboard da Equipa -->
            <div id="team-dashboard-view" class="view-content fade-in hidden">
                <!-- Content will be injected by JS -->
            </div>
        </main>
    </div>

    <!-- Modal do Perfil -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 w-full max-w-2xl rounded-2xl shadow-2xl p-6 relative max-h-[90vh] overflow-y-auto fade-in">
            <button id="close-profile-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i class="fas fa-times fa-lg"></i>
            </button>
            <h2 class="text-2xl font-bold mb-2">Meu Perfil</h2>
            <p id="profile-email" class="text-indigo-400 mb-6"></p>

            <div>
                 <h3 class="text-lg font-semibold mb-4">Desempenho nos Últimos 7 Dias</h3>
                 <div id="profile-dashboard-container" class="relative min-h-[280px]">
                    <!-- O conteúdo do dashboard do perfil será injetado aqui pelo JavaScript -->
                 </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Importar funções do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection,
            addDoc,
            onSnapshot,
            query,
            where,
            orderBy,
            limit,
            deleteDoc,
            getDocs,
            Timestamp,
            collectionGroup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // 1. CONFIGURAÇÃO DO FIREBASE
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAcSeRZc5wzhne2tuV-BWiKM2Euw9CJy9U",
            authDomain: "timerevereste.firebaseapp.com",
            projectId: "timerevereste",
            storageBucket: "timerevereste.appspot.com",
            messagingSenderId: "469617910016",
            appId: "1:469617910016:web:9076d1bb4905667bb353e5",
            measurementId: "G-K1YGJ0NHCL"
        };
        
        // =================================================================================
        // 2. INICIALIZAÇÃO E VARIÁVEIS GLOBAIS
        // =================================================================================
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let activeTasks = [];
        let timerIntervals = {};
        let unsubscribeActiveTasks = null;
        let unsubscribeRecentHistory = null;
        
        const TAG_OPTIONS = [
            "Gestão de Projetos", "Análise de Dados", "Desenvolvimento", 
            "Design UX/UI", "Marketing", "Reuniões", "Suporte ao Cliente", 
            "Planeamento Estratégico", "Recursos Humanos", "Outros"
        ];

        // Popular as tags
        const taskTagSelect = document.getElementById('task-tag');
        TAG_OPTIONS.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            taskTagSelect.appendChild(option);
        });
        
        // =================================================================================
        // 3. LÓGICA DE AUTENTICAÇÃO
        // =================================================================================
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const authForm = document.getElementById('auth-form');
        const authError = document.getElementById('auth-error');
        const toggleAuthModeLink = document.getElementById('toggle-auth-mode');
        const authTitle = document.getElementById('auth-title');
        const authPromptText = document.getElementById('auth-prompt-text');
        const authButton = document.getElementById('auth-button');

        let isLoginMode = true;

        // Alternar entre Login e Registo
        toggleAuthModeLink.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            authError.textContent = '';
            authForm.reset();

            if (isLoginMode) {
                authTitle.textContent = 'Bem-vindo de volta!';
                authButton.textContent = 'Entrar';
                authPromptText.textContent = 'Não tem uma conta?';
                toggleAuthModeLink.textContent = 'Registrar-se';
            } else {
                authTitle.textContent = 'Crie a sua conta';
                authButton.textContent = 'Registar';
                authPromptText.textContent = 'Já tem uma conta?';
                toggleAuthModeLink.textContent = 'Entrar';
            }
        });

        // Submeter formulário de autenticação
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            authError.textContent = '';

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Criar perfil de utilizador inicial no Firestore
                    const userProfileRef = doc(db, `artifacts/default-app-id/users/${userCredential.user.uid}/profile/settings`);
                    await setDoc(userProfileRef, { email: userCredential.user.email });
                }
                // onAuthStateChanged irá tratar da transição do UI
            } catch (error) {
                console.error("Authentication error:", error);
                handleAuthError(error);
            }
        });

        function handleAuthError(error) {
             switch (error.code) {
                case 'auth/invalid-email':
                    authError.textContent = 'Formato de e-mail inválido.';
                    break;
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                     authError.textContent = 'E-mail ou senha incorretos.';
                    break;
                case 'auth/email-already-in-use':
                     authError.textContent = 'Este e-mail já está a ser utilizado.';
                    break;
                case 'auth/weak-password':
                     authError.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                    break;
                default:
                     authError.textContent = 'Ocorreu um erro. Tente novamente.';
                    break;
            }
        }


        // Observador do estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                loadUserProfile();
                setupListeners();
            } else {
                currentUser = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                cleanupListeners();
                clearUI();
            }
        });

        // Logout
        document.getElementById('logout-button').addEventListener('click', async () => {
            await signOut(auth);
        });

        // =================================================================================
        // 4. LÓGICA DO TIMER E GESTÃO DE TAREFAS
        // =================================================================================
        const newTaskForm = document.getElementById('new-task-form');
        const taskLimitError = document.getElementById('task-limit-error');
        const activeTasksContainer = document.getElementById('active-tasks-container');
        
        // Iniciar nova tarefa
        newTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (activeTasks.length >= 3) {
                taskLimitError.textContent = 'Pode ter no máximo 3 tarefas ativas.';
                setTimeout(() => taskLimitError.textContent = '', 3000);
                return;
            }

            const taskName = document.getElementById('task-name').value;
            const taskTag = document.getElementById('task-tag').value;

            const newTask = {
                name: taskName,
                tag: taskTag,
                ownerId: currentUser.uid,
                status: 'paused',
                startTime: Timestamp.now(),
                lastStartTime: null,
                totalActiveTime: 0,
                totalPausedTime: 0,
                pauseCount: 0,
                lastPauseTime: Timestamp.now(),
            };

            try {
                const collectionRef = collection(db, `artifacts/default-app-id/users/${currentUser.uid}/active_tasks`);
                await addDoc(collectionRef, newTask);
                newTaskForm.reset();
            } catch (error) {
                console.error("Error adding new task:", error);
            }
        });

        // Iniciar ou Pausar um timer
        function startTimer(task) {
            if (timerIntervals[task.id]) return; // Já está a correr

            timerIntervals[task.id] = setInterval(() => {
                task.totalActiveTime++;
                const timerElement = document.getElementById(`timer-${task.id}`);
                if (timerElement) {
                    timerElement.textContent = formatTime(task.totalActiveTime);
                }
            }, 1000);
        }

        function pauseTimer(taskId) {
            clearInterval(timerIntervals[taskId]);
            delete timerIntervals[taskId];
        }

        // Atualizar o estado da tarefa no Firestore
        async function updateTaskInFirestore(taskId, updates) {
            if (!currentUser) return;
            const taskRef = doc(db, `artifacts/default-app-id/users/${currentUser.uid}/active_tasks`, taskId);
            await setDoc(taskRef, updates, { merge: true });
        }
        
        // Continuar uma tarefa
        async function continueTask(taskToContinue) {
             // Pausar todas as outras tarefas ativas
            for (const task of activeTasks) {
                if (task.id !== taskToContinue.id && task.status === 'running') {
                    await pauseTask(task);
                }
            }

            const now = Timestamp.now();
            const pauseDuration = now.seconds - taskToContinue.lastPauseTime.seconds;
            
            const updates = {
                status: 'running',
                lastStartTime: now,
                totalPausedTime: taskToContinue.totalPausedTime + pauseDuration
            };
            await updateTaskInFirestore(taskToContinue.id, updates);
        }
        
        // Pausar uma tarefa
        async function pauseTask(taskToPause) {
            const now = Timestamp.now();
            const activeDuration = now.seconds - taskToPause.lastStartTime.seconds;

            const updates = {
                status: 'paused',
                lastPauseTime: now,
                totalActiveTime: taskToPause.totalActiveTime + activeDuration,
                pauseCount: taskToPause.pauseCount + 1
            };
             await updateTaskInFirestore(taskToPause.id, updates);
        }

        // Finalizar uma tarefa
        async function finishTask(taskToFinish) {
            pauseTimer(taskToFinish.id); // Para o intervalo local
            let finalActiveTime = taskToFinish.totalActiveTime;

            if (taskToFinish.status === 'running') {
                 const now = Timestamp.now();
                 const activeDuration = now.seconds - taskToFinish.lastStartTime.seconds;
                 finalActiveTime += activeDuration;
            }

            const finishedTask = {
                name: taskToFinish.name,
                tag: taskToFinish.tag,
                ownerId: taskToFinish.ownerId,
                userEmail: currentUser.email, // Adicionar para o dashboard da equipa
                startTime: taskToFinish.startTime,
                endTime: Timestamp.now(),
                totalActiveTime: finalActiveTime,
                totalPausedTime: taskToFinish.totalPausedTime,
                pauseCount: taskToFinish.pauseCount
            };
            
            try {
                // Adicionar ao histórico (time_entries)
                const historyCollectionRef = collection(db, `artifacts/default-app-id/users/${currentUser.uid}/time_entries`);
                await addDoc(historyCollectionRef, finishedTask);

                // Remover da lista de tarefas ativas
                const taskRef = doc(db, `artifacts/default-app-id/users/${currentUser.uid}/active_tasks`, taskToFinish.id);
                await deleteDoc(taskRef);

            } catch(error) {
                console.error("Error finishing task: ", error);
            }
        }
        
        // Renderizar tarefas ativas
        function renderActiveTasks(tasks) {
            activeTasks = tasks; // Atualizar a variável global
            activeTasksContainer.innerHTML = '';
            if (tasks.length === 0) {
                 activeTasksContainer.innerHTML = `<p class="text-gray-400 text-center">Nenhuma tarefa ativa. Inicie uma acima!</p>`;
                 return;
            }
            
            tasks.forEach(task => {
                const isRunning = task.status === 'running';

                // Calcular tempo decorrido em tempo real
                let displayTime = task.totalActiveTime;
                if(isRunning && task.lastStartTime) {
                    const nowInSeconds = Math.floor(Date.now() / 1000);
                    displayTime += (nowInSeconds - task.lastStartTime.seconds);
                }

                const taskCard = document.createElement('div');
                taskCard.className = `p-4 rounded-xl shadow-lg flex flex-col md:flex-row items-center justify-between gap-4 transition-all duration-300 ${isRunning ? 'bg-green-800/50 border-2 border-green-500' : 'bg-gray-800'}`;
                taskCard.id = `task-${task.id}`;
                taskCard.innerHTML = `
                    <div class="flex-grow text-center md:text-left">
                        <div class="flex items-center gap-3">
                             ${isRunning ? '<span class="text-xs font-bold uppercase bg-green-500 text-gray-900 px-2 py-1 rounded">ATIVA</span>' : ''}
                            <h3 class="font-bold text-lg">${task.name || 'Tarefa sem nome'}</h3>
                        </div>
                        <p class="text-sm text-indigo-400">${task.tag}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-center">
                            <p class="text-2xl md:text-3xl font-mono" id="timer-${task.id}">${formatTime(displayTime)}</p>
                            <p class="text-xs text-gray-400">Tempo Ativo</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl md:text-3xl font-mono">${task.pauseCount}</p>
                            <p class="text-xs text-gray-400">Pausas</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        ${!isRunning ? `<button class="continue-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-play"></i></button>` : `<button class="pause-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-pause"></i></button>`}
                        <button class="finish-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition"><i class="fas fa-check"></i></button>
                    </div>
                `;
                activeTasksContainer.appendChild(taskCard);

                // Adicionar event listeners
                if(isRunning) {
                    taskCard.querySelector('.pause-btn').addEventListener('click', () => pauseTask(task));
                    startTimer({ ...task, totalActiveTime: displayTime }); // Inicia o contador local
                } else {
                    taskCard.querySelector('.continue-btn').addEventListener('click', () => continueTask(task));
                    pauseTimer(task.id);
                }
                taskCard.querySelector('.finish-btn').addEventListener('click', () => finishTask(task));
            });
        }
        
        // Renderizar histórico recente
        function renderRecentHistory(entries) {
            const container = document.getElementById('recent-history-container');
            const noHistoryEl = document.getElementById('no-recent-history');

            // Limpar apenas as entradas de histórico anteriores, não a mensagem de placeholder
            container.querySelectorAll('.history-item').forEach(item => item.remove());

            if (entries.length === 0) {
                if(noHistoryEl) noHistoryEl.classList.remove('hidden');
            } else {
                if(noHistoryEl) noHistoryEl.classList.add('hidden');
                entries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    // Adicionar uma classe para identificar os itens e facilitar a remoção
                    entryDiv.className = 'history-item bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                    entryDiv.innerHTML = `
                         <div>
                            <p class="font-semibold">${entry.name}</p>
                            <p class="text-xs text-indigo-400">${entry.tag}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-mono text-lg">${formatTime(entry.totalActiveTime)}</p>
                            <p class="text-xs text-gray-400">${new Date(entry.endTime.seconds * 1000).toLocaleDateString()}</p>
                        </div>
                    `;
                    container.appendChild(entryDiv);
                });
            }
        }
        
        // =================================================================================
        // 5. LÓGICA DOS DASHBOARDS E GRÁFICOS
        // =================================================================================
        let myPerfChart = null;
        let teamCategoryChart = null;
        let teamUserChart = null;
        
        async function loadMyPerformanceDashboard() {
            const container = document.getElementById('my-performance-view');
            
            container.innerHTML = `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                    <div class="fas fa-spinner fa-spin text-4xl text-indigo-400"></div>
                </div>`;

            if (!currentUser) {
                container.innerHTML = '';
                return;
            };

            try {
                const q = query(collection(db, `artifacts/default-app-id/users/${currentUser.uid}/time_entries`), orderBy('endTime', 'desc'));
                const querySnapshot = await getDocs(q);
                const entries = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const totalTime = entries.reduce((acc, curr) => acc + curr.totalActiveTime, 0);
                const totalTasks = entries.length;
                const avgTime = totalTasks > 0 ? totalTime / totalTasks : 0;

                const timeByCategory = entries.reduce((acc, curr) => {
                    acc[curr.tag] = (acc[curr.tag] || 0) + curr.totalActiveTime;
                    return acc;
                }, {});

                const chartLabels = Object.keys(timeByCategory);
                const chartData = Object.values(timeByCategory);

                const dashboardHTML = `
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${formatTime(totalTime)}</p><p class="text-gray-400">Tempo Total Registado</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${totalTasks}</p><p class="text-gray-400">Total de Tarefas</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${formatTime(avgTime)}</p><p class="text-gray-400">Tempo Médio por Tarefa</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-gray-800 p-6 rounded-xl" style="height: 400px;"><h3 class="font-bold mb-4">Meu Tempo por Categoria</h3><canvas id="my-perf-category-chart"></canvas></div>
                        <div class="bg-gray-800 p-6 rounded-xl" style="max-height: 400px; overflow-y: auto;"><h3 class="font-bold mb-4">Histórico Completo</h3>
                            <table class="w-full text-left text-sm">
                                <thead class="text-xs text-gray-400 uppercase bg-gray-700"><tr><th class="p-2">Tarefa</th><th class="p-2">Tempo</th><th class="p-2">Data</th></tr></thead>
                                <tbody>${entries.map(e => `<tr class="border-b border-gray-700"><td class="p-2">${e.name}<br><span class="text-indigo-400 text-xs">${e.tag}</span></td><td class="p-2 font-mono">${formatTime(e.totalActiveTime)}</td><td class="p-2">${new Date(e.endTime.seconds * 1000).toLocaleDateString()}</td></tr>`).join('')}</tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.innerHTML = dashboardHTML;

                const ctx = document.getElementById('my-perf-category-chart').getContext('2d');
                if (myPerfChart) myPerfChart.destroy();
                myPerfChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: chartLabels, datasets: [{ data: chartData, backgroundColor: generateColors(chartData.length) }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#d1d5db' } } } }
                });
            } catch (error) {
                console.error("Error loading My Performance Dashboard:", error);
                container.innerHTML = `<p class="text-red-400 text-center">Ocorreu um erro ao carregar os dados.</p>`;
            }
        }

        async function loadTeamDashboard() {
            const container = document.getElementById('team-dashboard-view');
            
            container.innerHTML = `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                    <div class="fas fa-spinner fa-spin text-4xl text-indigo-400"></div>
                </div>`;

            try {
                const timeEntriesQuery = query(collectionGroup(db, 'time_entries'), orderBy('endTime', 'desc'), limit(100));
                const snapshot = await getDocs(timeEntriesQuery);
                const allEntries = snapshot.docs.map(doc => doc.data());

                const totalTime = allEntries.reduce((sum, entry) => sum + entry.totalActiveTime, 0);
                const totalTasks = allEntries.length;
                const activeUsers = new Set(allEntries.map(e => e.ownerId)).size;

                const timeByCategory = allEntries.reduce((acc, curr) => {
                    acc[curr.tag] = (acc[curr.tag] || 0) + curr.totalActiveTime;
                    return acc;
                }, {});

                const timeByUser = allEntries.reduce((acc, curr) => {
                    const email = curr.userEmail || 'Desconhecido';
                    acc[email] = (acc[email] || 0) + curr.totalActiveTime;
                    return acc;
                }, {});
                
                const topUsers = Object.entries(timeByUser).sort((a, b) => b[1] - a[1]).slice(0, 10);

                const dashboardHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${formatTime(totalTime)}</p><p class="text-gray-400">Tempo Total da Equipe</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${totalTasks}</p><p class="text-gray-400">Total de Tarefas</p></div>
                        <div class="bg-gray-800 p-6 rounded-xl text-center"><p class="text-3xl font-bold text-indigo-400">${activeUsers}</p><p class="text-gray-400">Colaboradores Ativos</p></div>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-gray-800 p-6 rounded-xl" style="height: 400px;"><h3 class="font-bold mb-4">Tempo por Categoria (Equipe)</h3><canvas id="team-category-chart"></canvas></div>
                        <div class="bg-gray-800 p-6 rounded-xl" style="height: 400px;"><h3 class="font-bold mb-4">Top 10 Colaboradores</h3><canvas id="team-user-chart"></canvas></div>
                    </div>
                     <div class="bg-gray-800 p-6 rounded-xl" style="max-height: 400px; overflow-y: auto;"><h3 class="font-bold mb-4">Log de Atividades Recentes</h3>
                         <table class="w-full text-left text-sm">
                            <thead class="text-xs text-gray-400 uppercase bg-gray-700"><tr><th class="p-2">Colaborador</th><th class="p-2">Tarefa</th><th class="p-2">Tempo</th><th class="p-2">Data</th></tr></thead>
                            <tbody>${allEntries.slice(0, 50).map(e => `<tr class="border-b border-gray-700"><td class="p-2">${e.userEmail}</td><td class="p-2">${e.name}<br><span class="text-indigo-400 text-xs">${e.tag}</span></td><td class="p-2 font-mono">${formatTime(e.totalActiveTime)}</td><td class="p-2">${new Date(e.endTime.seconds * 1000).toLocaleString()}</td></tr>`).join('')}</tbody>
                        </table>
                     </div>
                `;
                container.innerHTML = dashboardHTML;

                const catCtx = document.getElementById('team-category-chart').getContext('2d');
                if (teamCategoryChart) teamCategoryChart.destroy();
                teamCategoryChart = new Chart(catCtx, {
                    type: 'bar',
                    data: { labels: Object.keys(timeByCategory), datasets: [{ label: 'Tempo', data: Object.values(timeByCategory), backgroundColor: generateColors(Object.keys(timeByCategory).length) }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db' } } }, plugins: { legend: { display: false } } }
                });
                
                const userCtx = document.getElementById('team-user-chart').getContext('2d');
                if (teamUserChart) teamUserChart.destroy();
                teamUserChart = new Chart(userCtx, {
                    type: 'bar',
                    data: { labels: topUsers.map(u => u[0]), datasets: [{ label: 'Tempo', data: topUsers.map(u => u[1]), backgroundColor: generateColors(topUsers.length) }] },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { y: { ticks: { color: '#d1d5db' } }, x: { ticks: { color: '#d1d5db' } } }, plugins: { legend: { display: false } } }
                });
            } catch (error) {
                console.error("Error loading Team Dashboard:", error);
                container.innerHTML = `<p class="text-red-400 text-center">Ocorreu um erro ao carregar os dados da equipa.</p>`;
                if (error.code === 'failed-precondition') {
                    console.error("Esta falha geralmente indica a falta de um índice no Firestore. Verifique a consola de erros do seu navegador; o Firebase deve fornecer um link direto para criar o índice necessário.");
                }
            }
        }

        // =================================================================================
        // 6. LÓGICA DO PERFIL E MODAIS
        // =================================================================================
        const profileModal = document.getElementById('profile-modal');
        let profileChart = null;
        
        // Abrir/Fechar modais
        document.getElementById('profile-button').addEventListener('click', () => {
             profileModal.classList.remove('hidden');
             loadProfileDashboard();
        });
        document.getElementById('close-profile-modal').addEventListener('click', () => profileModal.classList.add('hidden'));

        async function loadUserProfile() {
            if(!currentUser) return;
            const profileRef = doc(db, `artifacts/default-app-id/users/${currentUser.uid}/profile/settings`);
            const docSnap = await getDoc(profileRef);
            if (!docSnap.exists()) {
                // Se o perfil não existir (ex: utilizadores antigos), cria um
                 await setDoc(profileRef, { email: currentUser.email });
            }
            updateProfileModal();
        }
        
        function updateProfileModal() {
            document.getElementById('profile-email').textContent = currentUser.email;
        }
        
        async function loadProfileDashboard() {
            const container = document.getElementById('profile-dashboard-container');
            if (!container) {
                console.error("Contentor do dashboard do perfil não encontrado!");
                return;
            }

            // Mostrar o loader dentro do contentor
            container.innerHTML = `
                <div class="absolute inset-0 flex items-center justify-center bg-gray-800 rounded-lg">
                    <i class="fas fa-spinner fa-spin text-3xl text-indigo-400"></i>
                </div>
            `;

            try {
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const sevenDaysAgoTimestamp = Timestamp.fromDate(sevenDaysAgo);

                const q = query(
                    collection(db, `artifacts/default-app-id/users/${currentUser.uid}/time_entries`),
                    where('endTime', '>=', sevenDaysAgoTimestamp)
                );

                const snapshot = await getDocs(q);
                const entries = snapshot.docs.map(doc => doc.data());

                const totalTime = entries.reduce((sum, e) => sum + e.totalActiveTime, 0);

                const timeByCategory = entries.reduce((acc, curr) => {
                    acc[curr.tag] = (acc[curr.tag] || 0) + curr.totalActiveTime;
                    return acc;
                }, {});

                const contentHTML = `
                    <p class="text-center text-3xl font-bold text-indigo-400 mb-4">${formatTime(totalTime)}</p>
                    <div class="h-64">
                         <canvas id="profile-category-chart"></canvas>
                    </div>
                `;
                container.innerHTML = contentHTML;

                const ctx = document.getElementById('profile-category-chart').getContext('2d');
                if (profileChart) profileChart.destroy();
                profileChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(timeByCategory),
                        datasets: [{ data: Object.values(timeByCategory), backgroundColor: generateColors(Object.keys(timeByCategory).length) }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            } catch(error) {
                console.error("Erro ao carregar o dashboard do perfil:", error);
                container.innerHTML = `<div class="text-red-400 p-4">Ocorreu um erro ao carregar o seu desempenho.</div>`;
            }
        }

        // =================================================================================
        // 7. UTILITÁRIOS E GESTÃO DE ESTADO
        // =================================================================================
        
        // Gestão da navegação de vistas
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', () => {
                const viewId = button.dataset.view;
                
                // Mudar vista
                document.querySelectorAll('.view-content').forEach(view => view.classList.add('hidden'));
                document.getElementById(viewId).classList.remove('hidden');
                
                // Mudar estilo do botão
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.replace('bg-indigo-600', 'bg-gray-700'));
                button.classList.replace('bg-gray-700', 'bg-indigo-600');

                // Carregar dados para a vista
                if (viewId === 'my-performance-view') loadMyPerformanceDashboard();
                if (viewId === 'team-dashboard-view') loadTeamDashboard();
            });
        });

        // Listeners do Firestore
        function setupListeners() {
            if (!currentUser) return;
            cleanupListeners(); // Garantir que não há listeners duplicados

            // Listener para tarefas ativas
            const activeTasksQuery = query(collection(db, `artifacts/default-app-id/users/${currentUser.uid}/active_tasks`));
            unsubscribeActiveTasks = onSnapshot(activeTasksQuery, (snapshot) => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Limpar todos os intervalos antigos antes de renderizar
                Object.values(timerIntervals).forEach(clearInterval);
                timerIntervals = {};
                renderActiveTasks(tasks);
            });
            
            // Listener para histórico recente
            const recentHistoryQuery = query(collection(db, `artifacts/default-app-id/users/${currentUser.uid}/time_entries`), orderBy('endTime', 'desc'), limit(5));
            unsubscribeRecentHistory = onSnapshot(recentHistoryQuery, (snapshot) => {
                 const entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 renderRecentHistory(entries);
            }, (error) => {
                console.error("Falha ao carregar o histórico recente: ", error);
                if (error.code === 'failed-precondition') {
                    console.error("Esta falha geralmente indica a falta de um índice no Firestore. Verifique a consola de erros do seu navegador; o Firebase deve fornecer um link direto para criar o índice necessário.");
                }
            });
        }

        // Limpar listeners ao fazer logout
        function cleanupListeners() {
            if (unsubscribeActiveTasks) unsubscribeActiveTasks();
            if (unsubscribeRecentHistory) unsubscribeRecentHistory();
            Object.values(timerIntervals).forEach(clearInterval);
            timerIntervals = {};
        }
        
        function clearUI() {
            activeTasksContainer.innerHTML = '';
            document.getElementById('recent-history-container').innerHTML = `<p id="no-recent-history" class="text-gray-400">Ainda não há tarefas finalizadas.</p>`;
            document.getElementById('my-performance-view').innerHTML = '';
            document.getElementById('team-dashboard-view').innerHTML = '';
            // Resetar navegação
             document.querySelector('[data-view="timer-view"]').click();
        }

        // Função para formatar segundos em HH:MM:SS
        function formatTime(totalSeconds) {
            if(isNaN(totalSeconds) || totalSeconds < 0) return "00:00:00";
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        
        // Função para gerar cores para os gráficos
        function generateColors(numColors) {
            const colors = [
                '#4f46e5', '#7c3aed', '#db2777', '#f97316', 
                '#eab308', '#84cc16', '#10b981', '#06b6d4', '#3b82f6'
            ];
            let result = [];
            for (let i = 0; i < numColors; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }
    </script>
</body>
</html>
